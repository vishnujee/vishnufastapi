<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="/static/css/stylesclean.css" rel="stylesheet">

</head>

<body>
    <div class="container">
        <div class="header">
            <div style="margin-bottom: 20px;">
                <a href="/" class="btn btn-primary" style="text-decoration: none;">
                    üè† Homepage
                </a>
            </div>
            <h1>Admin Panel</h1>
            <div class="subtitle">Monitor and clean up orphaned files across all directories</div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="oldFiles">0</div>
                    <div class="stat-label">Files >15 min</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSize">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="directoriesCount">5</div>
                    <div class="stat-label">Directories</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="loadFiles()">
                    üîÑ Refresh Files
                </button>
                <button class="btn btn-danger" onclick="runCleanup()" id="cleanupBtn">
                    üóëÔ∏è Run Cleanup Now
                </button>
                <button class="btn btn-success" onclick="toggleLogs()" id="logsBtn">
                    üìã Show Logs
                </button>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">Logs will appear here...</div>
            </div>

            <div class="status" id="status"></div>
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: Never
        </div>

        <!-- Cron Status Section -->
        <div class="cron-status">
            <div class="cron-header">
                <h3>üïí Cron Job Status</h3>
                <button class="btn btn-info" onclick="viewDetailedCronLogs()">
                    üìã View Cron Logs
                </button>
            </div>

            <div class="cron-stats">
                <div class="cron-stat">
                    <div class="cron-label">Last Run</div>
                    <div class="cron-value" id="lastCronRun">Loading...</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Next Run In</div>
                    <div class="cron-value" id="nextCronRun">Loading...</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Log Size</div>
                    <div class="cron-value" id="logSize">Loading...</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Total Runs</div>
                    <div class="cron-value" id="totalRuns">Loading...</div>
                </div>
            </div>

            <div class="recent-logs" id="recentLogs">
                <div class="log-line">Loading cron logs...</div>
            </div>
        </div>

        <!-- Backend Logs Section -->
        <!-- Backend Logs Section -->
        <div class="cron-status">
            <div class="cron-header">
                <h3 onclick="viewCompleteBackendLog()"
                    style="cursor: pointer; color: #007bff; user-select: none; display: flex; align-items: center; gap: 10px;">
                    üîß Backend Logs
                    <span style="font-size: 0.7em; color: #666; cursor: help;"
                        title="Click to view complete logs">(Click for full log)</span>
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-info" onclick="refreshBackendLogs()">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-success" onclick="viewCompleteBackendLog()">
                        üìã Full Log
                    </button>
                </div>
            </div>

            <div class="cron-stats">
                <div class="cron-stat">
                    <div class="cron-label">Log File</div>
                    <div class="cron-value">backend.log</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Log Size</div>
                    <div class="cron-value" id="backendLogSize">Loading...</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Last Updated</div>
                    <div class="cron-value" id="backendLogUpdated">Loading...</div>
                </div>
                <div class="cron-stat">
                    <div class="cron-label">Total Entries</div>
                    <div class="cron-value" id="backendLogEntries">Loading...</div>
                </div>
            </div>

            <div class="recent-logs" id="backendLogs">
                <div class="log-line">Loading backend logs...</div>
            </div>
        </div>

        <div class="directories" id="directoriesContainer">
            <!-- Directories will be populated by JavaScript -->
        </div>
    </div>


    <script>
        function handleMobileAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const isMobile = urlParams.get('mobile');

            console.log('Mobile auth check:', { urlToken, isMobile });

            if (urlToken) {
                // We have a token from mobile redirect - store it everywhere
                localStorage.setItem('auth_token', urlToken);
                sessionStorage.setItem('auth_token', urlToken);

                // Also set as cookie for future requests
                document.cookie = `session_token=${urlToken}; max-age=3600; path=/; samesite=lax`;

                // Clean up URL for security
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);

                addLog('‚úÖ Mobile authentication successful! Token stored.', 'success');
                return true;
            }

            // Check if we have token from other sources
            const storedToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
            if (storedToken) {
                addLog('‚úÖ Using stored authentication token', 'success');
                return true;
            }

            // No token found
            if (isMobile) {
                addLog('‚ö†Ô∏è Mobile device detected but no authentication token found', 'warning');
                addLog('üîê Please ensure you are logged in', 'info');
            }

            return false;
        }

        // ========== AUTHENTICATION HELPERS ==========
        async function makeAuthenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('auth_token');

            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                window.location.href = '/login';
                throw new Error('Authentication required');
            }

            return response;
        }

        function attemptMobileAuthRecovery() {
            // Check if we have a token in URL (mobile redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const isMobile = urlParams.get('mobile');

            if (urlToken) {
                // Save token from URL for future requests
                localStorage.setItem('auth_token', urlToken);
                sessionStorage.setItem('auth_token', urlToken);

                // Clean up URL (remove token for security)
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);

                addLog('‚úÖ Mobile authentication token recovered from URL', 'success');
            }

            // If mobile and no token, try to get from multiple sources
            if (isMobile && !localStorage.getItem('auth_token')) {
                addLog('‚ö†Ô∏è Mobile device detected - attempting authentication recovery', 'warning');

                // Try to reload with stored credentials (if any)
                const storedUsername = localStorage.getItem('username');
                if (storedUsername) {
                    addLog('Found stored credentials, attempting auto-login...', 'info');
                    // You could implement auto-login here if needed
                }
            }
        }
        // ========== EXISTING VARIABLES ==========
        let filesData = {};
        let isAuthenticated = false;

        // ========== EXISTING UTILITY FUNCTIONS ==========
        // Format file size
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Format time
        function formatTime(seconds) {
            if (seconds < 60) return Math.round(seconds) + 's';
            if (seconds < 3600) return Math.round(seconds / 60) + 'm';
            return Math.round(seconds / 3600) + 'h';
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status status-${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // ========== UPDATED API CALLS ==========
        // Get cleanup status from API
        async function getCleanupStatus() {
            try {
                const response = await makeAuthenticatedRequest('/cleanup-status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                addLog(`Error fetching cleanup status: ${error.message}`, 'error');
                return null;
            }
        }

        // Get cron logs from API
        async function getCronLogs() {
            try {
                const response = await makeAuthenticatedRequest('/cleanup-logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching cron logs:', error);
                return null;
            }
        }

        // Get backend logs from API
        async function getBackendLogs() {
            try {
                const response = await makeAuthenticatedRequest('/backend-logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching backend logs:', error);
                return null;
            }
        }

        // ========== EXISTING UI FUNCTIONS ==========
        // Toggle logs visibility
        function toggleLogs() {
            const logContainer = document.getElementById('logContainer');
            const logsBtn = document.getElementById('logsBtn');

            if (logContainer.style.display === 'block') {
                logContainer.style.display = 'none';
                logsBtn.textContent = 'üìã Show Logs';
            } else {
                logContainer.style.display = 'block';
                logsBtn.textContent = 'üìã Hide Logs';
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // View detailed cron logs
        // Replace the viewDetailedCronLogs function:
        async function viewDetailedCronLogs() {
            try {
                const response = await makeAuthenticatedRequest('/cleanup-logs');
                const data = await response.json();

                // Remove any existing modal first
                closeCronLogModal();

                // Create modal
                const modal = document.createElement('div');
                modal.className = 'cron-log-modal';

                const logContent = data.logs || 'No log content available';
                const formattedLogContent = formatLogContentWithColors(logContent);

                // In the viewDetailedCronLogs() function, update the modal-stats section:
                modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>üïí Complete Cron Logs</h3>
                                <div class="modal-controls">
                                    <button class="modal-btn refresh" onclick="refreshCronLogs()">
                                        üîÑ Refresh
                                    </button>
                                    <button class="modal-btn close" onclick="closeCronLogModal()">
                                        ‚ùå Close
                                    </button>
                                </div>
                            </div>
                            
                            <div class="modal-body">
                                <div class="modal-stats">
                                    <div class="stat-card">
                                        <div class="stat-label">Total Runs</div>
                                        <div class="stat-value">${data.total_runs || 0}</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Log Size</div>
                                        <div class="stat-value">${data.file_size || '0 KB'}</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Last Updated</div>
                                        <div class="stat-value">${data.last_updated ? new Date(data.last_updated * 1000).toLocaleDateString() : 'Never'}</div>
                                    </div>
                                </div>

                                <div class="complete-log-content">
                                    ${formattedLogContent}
                                </div>
                            </div>
                        </div>
                    `;

                document.body.appendChild(modal);

            } catch (error) {
                alert('Error loading cron logs: ' + error.message);
            }
        }

        function closeCronLogModal() {
            const modal = document.querySelector('.cron-log-modal');
            if (modal) modal.remove();
        }

        async function refreshCronLogs() {
            try {
                const logContentElement = document.querySelector('.cron-log-modal .complete-log-content');
                if (logContentElement) {
                    logContentElement.innerHTML = '<div class="loading-log">Refreshing cron logs...</div>';
                }

                const response = await makeAuthenticatedRequest('/cleanup-logs');
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const formattedLogContent = formatLogContentWithColors(data.logs || data.recent_entries?.join('\n'));

                if (logContentElement) {
                    logContentElement.innerHTML = formattedLogContent;
                    // Scroll to bottom to show latest logs
                    setTimeout(() => {
                        logContentElement.scrollTop = logContentElement.scrollHeight;
                    }, 100);
                }

                // Update modal stats - only if they exist
                const statCards = document.querySelectorAll('.cron-log-modal .stat-card');
                if (statCards.length >= 3) {
                    statCards[0].querySelector('.stat-value').textContent = data.total_runs || 0;
                    statCards[1].querySelector('.stat-value').textContent = data.file_size || '0 KB';
                    statCards[2].querySelector('.stat-value').textContent = data.last_updated ?
                        new Date(data.last_updated * 1000).toLocaleDateString() : 'Never';
                }

            } catch (error) {
                console.error('Error refreshing cron logs:', error);
                // Show error in modal
                const logContentElement = document.querySelector('.cron-log-modal .complete-log-content');
                if (logContentElement) {
                    logContentElement.innerHTML = `<div class="log-line-modal error">Error refreshing logs: ${error.message}</div>`;
                }
            }
        }
        // Update backend logs UI
        function updateBackendLogsUI(data) {
            if (!data) {
                document.getElementById('backendLogSize').textContent = 'No data';
                document.getElementById('backendLogUpdated').textContent = 'Unknown';
                document.getElementById('backendLogEntries').textContent = '0';
                document.getElementById('backendLogs').innerHTML = '<div class="log-line">No logs available</div>';
                return;
            }

            document.getElementById('backendLogSize').textContent = data.file_size || '0 KB';
            document.getElementById('backendLogEntries').textContent = data.total_entries || '0';

            if (data.last_updated) {
                const lastUpdated = new Date(data.last_updated * 1000);
                document.getElementById('backendLogUpdated').textContent = lastUpdated.toLocaleString();
            } else {
                document.getElementById('backendLogUpdated').textContent = 'Never';
            }

            const recentLogs = data.recent_entries || [];
            const recentLogsHTML = recentLogs.map(log => {
                let className = 'log-line';
                if (log.includes('ERROR') || log.includes('‚ùå') || log.includes('üí•') || log.toLowerCase().includes('error'))
                    className += ' error';
                else if (log.includes('SUCCESS') || log.includes('‚úÖ') || log.includes('üéØ') || log.toLowerCase().includes('success'))
                    className += ' success';
                else if (log.includes('WARNING') || log.includes('‚ö†Ô∏è') || log.toLowerCase().includes('warning'))
                    className += ' warning';

                return `<div class="${className}">${log}</div>`;
            }).join('');

            document.getElementById('backendLogs').innerHTML = recentLogsHTML || '<div class="log-line">No recent logs</div>';
        }

        // Refresh backend logs
        async function refreshBackendLogs() {
            addLog('Refreshing backend logs...', 'info');
            const backendData = await getBackendLogs();
            updateBackendLogsUI(backendData);
            addLog('Backend logs refreshed', 'success');
        }

        // Update cron status UI
        function updateCronUI(data) {
            if (!data) {
                document.getElementById('lastCronRun').textContent = 'No data';
                document.getElementById('nextCronRun').textContent = 'Unknown';
                document.getElementById('logSize').textContent = '0 KB';
                document.getElementById('totalRuns').textContent = '0';
                document.getElementById('recentLogs').innerHTML = '<div class="log-line">No logs available</div>';
                return;
            }

            document.getElementById('logSize').textContent = data.file_size || '0 KB';
            document.getElementById('totalRuns').textContent = data.total_runs || '0';

            // Calculate next run (every 15 minutes)
            const now = new Date();
            const currentMinute = now.getMinutes();
            let minutesToNextRun;

            if (currentMinute < 15) minutesToNextRun = 15 - currentMinute;
            else if (currentMinute < 30) minutesToNextRun = 30 - currentMinute;
            else if (currentMinute < 45) minutesToNextRun = 45 - currentMinute;
            else minutesToNextRun = 60 - currentMinute + 15;

            document.getElementById('nextCronRun').textContent = `${minutesToNextRun} min`;

            if (data.last_updated) {
                const lastRun = new Date(data.last_updated * 1000);
                document.getElementById('lastCronRun').textContent = lastRun.toLocaleTimeString();
            } else {
                document.getElementById('lastCronRun').textContent = 'Never';
            }

            const recentLogs = data.recent_entries || [];
            const reversedLogs = [...recentLogs].reverse();

            const recentLogsHTML = reversedLogs.map(log => {
                let className = 'log-line';
                if (log.includes('ERROR') || log.includes('‚ùå') || log.includes('üí•')) className += ' error';
                else if (log.includes('SUCCESS') || log.includes('‚úÖ') || log.includes('üéØ')) className += ' success';
                else if (log.includes('WARNING') || log.includes('‚ö†Ô∏è')) className += ' warning';

                return `<div class="${className}">${log}</div>`;
            }).join('');

            document.getElementById('recentLogs').innerHTML = recentLogsHTML || '<div class="log-line">No recent logs</div>';
        }

        // ========== FILE MANAGEMENT FUNCTIONS ==========
        // Load files from all directories
        async function loadFiles() {
            addLog('Loading files from all directories...', 'info');
            showStatus('Loading files...', 'loading');

            const btn = document.getElementById('cleanupBtn');
            btn.disabled = true;

            try {
                const [statusData, cronData, backendData] = await Promise.all([
                    getCleanupStatus(),
                    getCronLogs(),
                    getBackendLogs()
                ]);

                if (!statusData) {
                    throw new Error('Could not fetch file data from server');
                }

                if (statusData.error) {
                    throw new Error(statusData.error);
                }

                let totalFiles = 0;
                let oldFiles = 0;
                let totalSizeBytes = 0;
                filesData = {};

                for (const [dirName, dirData] of Object.entries(statusData.directories || {})) {
                    filesData[dirName] = [];

                    const fileCount = dirData.total_files || 0;
                    const oldFileCount = dirData.old_files || 0;

                    totalFiles += fileCount;
                    oldFiles += oldFileCount;

                    for (let i = 0; i < fileCount; i++) {
                        const isOld = i < oldFileCount;
                        const fileSize = Math.random() * 1024 * 1024 * 5;
                        const fileAge = isOld ? 900 + Math.random() * 3600 : Math.random() * 900;

                        filesData[dirName].push({
                            name: `file_${i + 1}${getFileExtension(dirName)}`,
                            size: fileSize,
                            age: fileAge,
                            path: `${dirName}/file_${i + 1}`,
                            modified: Date.now() / 1000 - fileAge
                        });

                        totalSizeBytes += fileSize;
                    }

                    addLog(`Found ${fileCount} files in ${dirName} (${oldFileCount} old)`, 'info');
                }

                updateStatistics(totalFiles, oldFiles, totalSizeBytes);
                renderDirectories();

                updateCronUI(cronData);
                updateBackendLogsUI(backendData);

                showStatus(`Loaded ${totalFiles} files across ${Object.keys(statusData.directories || {}).length} directories`, 'success');
                addLog(`File scan completed: ${totalFiles} files found, ${oldFiles} older than 15 minutes`, 'success');

                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleString()}`;

            } catch (error) {
                showStatus('Error loading files: ' + error.message, 'error');
                addLog(`Error: ${error.message}`, 'error');
                renderEmptyState();
            } finally {
                btn.disabled = false;
            }
        }

        // Helper function to get file extensions
        function getFileExtension(dirName) {
            const extensions = {
                'uploads': '.pdf',
                'output': '.pdf',
                'estimation': '.json',
                'word': '.docx',
                'temp_processing': '.tmp'
            };
            return extensions[dirName] || '.tmp';
        }

        // Update statistics
        function updateStatistics(totalFiles, oldFiles, totalSizeBytes) {
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('oldFiles').textContent = oldFiles;
            document.getElementById('totalSize').textContent = formatSize(totalSizeBytes);
            document.getElementById('directoriesCount').textContent = Object.keys(filesData).length;
        }

        // Render empty state
        function renderEmptyState() {
            const container = document.getElementById('directoriesContainer');
            container.innerHTML = `
            <div class="empty-state">
                <div>üìÅ</div>
                <h3>No File Data Available</h3>
                <p>Unable to fetch file information from the server.</p>
            </div>
        `;
        }

        // Render directories and files
        function renderDirectories() {
            const container = document.getElementById('directoriesContainer');

            if (Object.keys(filesData).length === 0) {
                renderEmptyState();
                return;
            }

            container.innerHTML = '';

            Object.entries(filesData).forEach(([dir, files]) => {
                const oldFilesCount = files.filter(f => f.age > 900).length;

                const directoryCard = document.createElement('div');
                directoryCard.className = 'directory-card';
                directoryCard.innerHTML = `
                <div class="directory-header">
                    <div class="directory-name">üìÅ ${dir.toUpperCase()}</div>
                    <div class="file-count">${files.length} files</div>
                </div>
                <div class="file-list">
                    ${files.length === 0 ?
                        '<div style="text-align: center; color: #666; padding: 20px;">No files</div>' :
                        files.map(file => `
                            <div class="file-item ${file.age > 900 ? 'old' : ''}">
                                <div class="file-info">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-details">
                                        ${formatSize(file.size)} ‚Ä¢ 
                                        Modified: ${new Date(file.modified * 1000).toLocaleString()}
                                    </div>
                                </div>
                                <div class="file-age ${file.age > 900 ? 'age-old' : 'age-new'}">
                                    ${formatTime(file.age)}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                ${oldFilesCount > 0 ?
                        `<div style="margin-top: 10px; color: #dc3545; font-size: 0.9em;">
                        ‚ö†Ô∏è ${oldFilesCount} files older than 15 minutes
                    </div>` : ''
                    }
            `;

                container.appendChild(directoryCard);
            });
        }

        // // open backendlog 
        // ========== COMPLETE BACKEND LOG MODAL FUNCTIONS ==========

        async function viewCompleteBackendLog() {
            try {
                addLog('Loading complete backend log...', 'info');

                const response = await makeAuthenticatedRequest('/backend-logs');
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Remove any existing modal first
                closeBackendLogModal();

                // Create modal to show complete log
                const modal = document.createElement('div');
                modal.className = 'backend-log-modal';

                // Format log content with color coding
                const logContent = data.recent_entries ? data.recent_entries.join('\n') : data.logs || 'No log content available';
                const formattedLogContent = formatLogContentWithColors(logContent);
                modal.innerHTML = `
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìã Complete Backend Log</h3>
            <div class="modal-controls">
                <button class="modal-btn download" onclick="downloadBackendLog()" title="Download log file">
                    üì• Download
                </button>
                <button class="modal-btn refresh" onclick="refreshCompleteBackendLog()" title="Refresh log content">
                    üîÑ Refresh
                </button>
                <button class="modal-btn close" onclick="closeBackendLogModal()" title="Close modal">
                    ‚ùå Close
                </button>
            </div>
        </div>
        
        <div class="modal-body">
            <div class="modal-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Lines</div>
                    <div class="stat-value">${data.total_entries || data.line_count || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">File Size</div>
                    <div class="stat-value">${data.file_size || '0 KB'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Updated</div>
                    <div class="stat-value">${data.last_updated ? new Date(data.last_updated * 1000).toLocaleDateString() : 'Unknown'}</div>
                </div>
            </div>

            <div id="completeBackendLogContent" class="complete-log-content">
                ${formattedLogContent}
            </div>
        </div>
        
        <div class="modal-footer">
            <div class="footer-info">
                <div class="footer-tips">
                    üéØ <strong>Tips:</strong> Scroll to navigate ‚Ä¢ ESC to close ‚Ä¢ Click outside to close
                </div>
                <div>
                    Last refreshed: <strong>${new Date().toLocaleString()}</strong>
                </div>
            </div>
        </div>
    </div>
`;

                document.body.appendChild(modal);
                addLog('Complete backend log modal opened', 'success');

                // Add keyboard shortcut to close modal with ESC key
                const handleKeydown = (event) => {
                    if (event.key === 'Escape') {
                        closeBackendLogModal();
                    }
                };
                modal._keydownHandler = handleKeydown;
                document.addEventListener('keydown', handleKeydown);

            } catch (error) {
                addLog(`Error loading complete backend log: ${error.message}`, 'error');
                alert('Error loading complete log: ' + error.message);
            }
        }

        function formatLogContentWithColors(logContent) {
            if (!logContent) return '<div class="log-line-modal">No log content available</div>';

            const lines = logContent.split('\n');
            return lines.map(line => {
                if (!line.trim()) return '<div class="log-line-modal">&nbsp;</div>';

                let className = 'log-line-modal info';
                const lowerLine = line.toLowerCase();

                if (line.includes('ERROR') || line.includes('‚ùå') || line.includes('üí•') || lowerLine.includes('error')) {
                    className = 'log-line-modal error';
                } else if (line.includes('SUCCESS') || line.includes('‚úÖ') || line.includes('üéØ') || lowerLine.includes('success')) {
                    className = 'log-line-modal success';
                } else if (line.includes('WARNING') || line.includes('‚ö†Ô∏è') || lowerLine.includes('warning')) {
                    className = 'log-line-modal warning';
                }

                // Escape HTML to prevent XSS
                const escapedLine = line
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');

                return `<div class="${className}">${escapedLine}</div>`;
            }).join('');
        }

        function closeBackendLogModal() {
            const modal = document.querySelector('.backend-log-modal');
            if (modal) {
                // Remove keyboard event listener
                if (modal._keydownHandler) {
                    document.removeEventListener('keydown', modal._keydownHandler);
                }
                modal.remove();
                addLog('Backend log modal closed', 'info');
            }
        }

       async function refreshCompleteBackendLog() {
    try {
        const logContentElement = document.querySelector('.backend-log-modal .complete-log-content');
        if (logContentElement) {
            logContentElement.innerHTML = '<div class="loading-log">Refreshing log content...</div>';
        }
        
        const response = await makeAuthenticatedRequest('/backend-logs');
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        const formattedLogContent = formatLogContentWithColors(data.recent_entries ? data.recent_entries.join('\n') : data.logs);
        
        if (logContentElement) {
            logContentElement.innerHTML = formattedLogContent;
            // Scroll to bottom to show latest logs
            setTimeout(() => {
                logContentElement.scrollTop = logContentElement.scrollHeight;
            }, 100);
        }
        
        // Update modal stats - only if they exist in backend modal
        const statCards = document.querySelectorAll('.backend-log-modal .stat-card');
        if (statCards.length >= 3) {
            statCards[0].querySelector('.stat-value').textContent = data.total_entries || data.line_count || 0;
            statCards[1].querySelector('.stat-value').textContent = data.file_size || '0 KB';
            statCards[2].querySelector('.stat-value').textContent = data.last_updated ? 
                new Date(data.last_updated * 1000).toLocaleDateString() : 'Unknown';
        }
        
        // Update footer - only if it exists in backend modal
        const footer = document.querySelector('.backend-log-modal .footer-info div:last-child');
        if (footer) {
            footer.innerHTML = `Last refreshed: <strong>${new Date().toLocaleString()}</strong>`;
        }
        
        addLog('Complete backend log refreshed', 'success');
    } catch (error) {
        addLog(`Error refreshing complete backend log: ${error.message}`, 'error');
        // Show error in modal
        const logContentElement = document.querySelector('.backend-log-modal .complete-log-content');
        if (logContentElement) {
            logContentElement.innerHTML = `<div class="log-line-modal error">Error refreshing logs: ${error.message}</div>`;
        }
    }
}
        function downloadBackendLog() {
            // Create a temporary link to download the log content
            const logContentElement = document.getElementById('completeBackendLogContent');
            if (!logContentElement) return;

            // Get plain text content without HTML tags
            const plainText = logContentElement.innerText || logContentElement.textContent;
            const blob = new Blob([plainText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `backend_log_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('Backend log downloaded', 'success');
        }

        // Close modal when clicking outside content
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('backend-log-modal')) {
                closeBackendLogModal();
            }
        });


        ///////////////////////
        // Run cleanup
        async function runCleanup() {
            const btn = document.getElementById('cleanupBtn');
            btn.disabled = true;
            btn.textContent = 'Cleaning...';

            addLog('Starting cleanup process...', 'warning');
            showStatus('Cleanup in progress...', 'loading');

            try {
                const response = await makeAuthenticatedRequest('/test-cleanup', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('‚úÖ Cleanup started successfully', 'success');
                    addLog(`üïí Cleanup triggered at: ${new Date().toLocaleString()}`, 'info');

                    showStatus('Cleanup completed! Refreshing file list...', 'success');

                    setTimeout(() => {
                        loadFiles();
                        addLog('‚úÖ File list refreshed after cleanup', 'success');
                    }, 2000);

                } else {
                    throw new Error(data.detail || 'Cleanup failed');
                }
            } catch (error) {
                addLog(`‚ùå Cleanup error: ${error.message}`, 'error');
                showStatus('Cleanup failed: ' + error.message, 'error');
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'üóëÔ∏è Run Cleanup Now';
                }, 3000);
            }
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function () {
            addLog('File Cleanup Manager initialized', 'info');

            // Handle mobile authentication first
            const isAuthenticated = handleMobileAuthentication();

            if (isAuthenticated) {
                loadFiles();
            } else {
                addLog('‚ùå Not authenticated. Redirecting to login...', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        });
    </script>


</body>

</html>